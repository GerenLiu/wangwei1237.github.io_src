on: [push]

jobs:
  release_the_17g_website:
    runs-on: ubuntu-latest
    name: build and release for the 17g website
    steps:
      - name: Setup Node.js 10.x 
        uses: actions/setup-node@v2
        with:
          node-version: "14" 
        
      - name: Install hexo and gitbook
        run: |
          npm install hexo-cli -g
          npm install -g gitbook-cli

      - name: Checkout main source
        uses: actions/checkout@v2
      
      - name: Checkout all books source
        working-directory: ${{ github.workspace }}/../
        run: |
          /usr/bin/git clone https://github.com/wangwei1237/chaos-engineering.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/digital_video_concepts.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/temperature-of-the-idioms.git --depth 1  
          /usr/bin/git clone https://github.com/wangwei1237/monolith-to-microservices.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/discovery-the-unpredictable-risk.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/Kubernetes-in-Action-Second-Edition.git --depth 1

      - name: build the main website
        working-directory: ${{ github.workspace }}
        run: |
          npm install && /bin/cp -rf misc/bilibili-embed-convert/* node_modules/bilibili-embed-convert/ 
          hexo clean && hexo generate

      - name: build the books
        working-directory: ${{ github.workspace }}/../
        run: | 
          cp wangwei1237.github.io_src/build_books.sh .
          /bin/bash ./build_books.sh "${{ github.workspace }}/../"
      
      - name: release the website
        working-directory: ${{ github.workspace }}
        run: |
          /bin/bash ./release.sh "${{ github.workspace }}/../"
          ls -lR public
      - name: deploy the website
        id: deploy
        uses: sma11black/hexo-action@v1.0.3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}
          user_name: Wang Wei
          user_email: wangwei1237@gmail.com
          commit_msg: ${{ github.event.head_commit.message }}

          

on: [push]

jobs:
  release_the_17g_website:
    runs-on: ubuntu-latest
    name: build and release for the 17g website
    steps:
      - name: Setup Node.js 10.x 
        uses: actions/setup-node@v2
        with:
          node-version: "14" 
        
      - name: Install hexo and gitbook
        run: |
          npm install hexo-cli -g
          npm install -g gitbook-cli

      - name: Checkout main source
        uses: actions/checkout@v2
      
      - name: Checkout all books source
        working-directory: ${{ github.workspace }}
        run: |
          /usr/bin/git clone https://github.com/wangwei1237/chaos-engineering.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/digital_video_concepts.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/temperature-of-the-idioms.git --depth 1  
          /usr/bin/git clone https://github.com/wangwei1237/monolith-to-microservices.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/discovery-the-unpredictable-risk.git --depth 1
          /usr/bin/git clone https://github.com/wangwei1237/Kubernetes-in-Action-Second-Edition.git --depth 1

      - name: build the main website
        working-directory: ${{ github.workspace }}
        run: |
          cd wangwei1237.github.io_src && npm install && hexo clean && hexo generate

      - name: build the books
        working-directory: ${{ github.workspace }}
        run: | 
          cp wangwei1237.github.io_src/build_books.sh .
          sh ./build_books.sh ${{ github.workspace }} 
          ls -R ${{ github.workspace }}/books
